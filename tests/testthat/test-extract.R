
context("Extract covariates and polygon data")

polygons <- list()
for(i in 1:100) {
  row <- ceiling(i/10)
  col <- ifelse(i %% 10 != 0, i %% 10, 10)
  xmin = 2*(col - 1); xmax = 2*col; ymin = 2*(row - 1); ymax = 2*row
  polygons[[i]] <- rbind(c(xmin, ymax), c(xmax,ymax), c(xmax, ymin), c(xmin,ymin))
}

polys <- do.call(raster::spPolygons, polygons)
N <- floor(runif(100, min = 1, max = 100))
response_df <- data.frame(area_id = 1:100, response = runif(100, min = 0, max = 1000))
response_binom_df <- data.frame(area_id = 1:100, response = N*runif(100, min = 0, max = 1), sample_size = N)

spdf <- sp::SpatialPolygonsDataFrame(polys, response_df)
spdf_binom <- sp::SpatialPolygonsDataFrame(polys, response_binom_df)


# Create raster stack
r <- raster::raster(ncol=20, nrow=20)
r <- raster::setExtent(r, raster::extent(spdf))
r[] <- sapply(1:raster::ncell(r), function(x) rnorm(1, ifelse(x %% 20 != 0, x %% 20, 20), 3))
r2 <- raster::raster(ncol=20, nrow=20)
r2 <- raster::setExtent(r2, raster::extent(spdf))
r2[] <- sapply(1:raster::ncell(r), function(x) rnorm(1, ceiling(x/10), 3))
cov_stack <- raster::stack(r, r2)


test_that("parallelExtract gives errors when it should", {
  
  cl <- parallel::makeCluster(2)
  doParallel::registerDoParallel(cl)
  
  expect_error(parallelExtract(spdf, cov_stack, fun = NULL, id = 'area_id'))
  expect_error(parallelExtract(cov_stack, spdf, fun = NULL, id = 'id'))
  
  parallel::stopCluster(cl)
  foreach::registerDoSEQ()
})

test_that("parallelExtract give the right for of output", {
  
  cl <- parallel::makeCluster(2)
  doParallel::registerDoParallel(cl)
  result1 <- parallelExtract(cov_stack, spdf, fun = NULL, id = 'area_id')
  result2 <- parallelExtract(cov_stack, spdf, fun = sum, id = 'area_id')
  parallel::stopCluster(cl)
  foreach::registerDoSEQ()
  
  expect_is(result1, 'data.frame')
  expect_equal(sort(as.numeric(unique(result1$area_id))), spdf$area_id)#
  expect_equal(ncol(result1), raster::nlayers(cov_stack) + 2)#
  expect_equal(names(cov_stack), names(result1)[-c(1,2)])#
  expect_equal(length(unique(result1$area_id)), length(spdf))
  
  expect_is(result2, 'data.frame')
  expect_equal(sort(as.numeric(result2$area_id)), spdf$area_id)#
  expect_equal(ncol(result2), raster::nlayers(cov_stack) + 1)#
  expect_equal(names(cov_stack), names(result2)[-c(1)])
  expect_equal(length(unique(result2$area_id)), length(spdf))
  
})

test_that("getPolygonData function", {
  
  expect_error(getPolygonData(spdf, id_var = 'id', response_var = 'response'))
  expect_error(getPolygonData(spdf, id_var = 'area_id', response_var = 'data'))
  
  result <- getPolygonData(spdf, id_var = 'area_id', response_var = 'response')
  result_binom <- getPolygonData(spdf_binom, id_var = 'area_id', response_var = 'response', sample_size_var = 'sample_size')
  
  expect_is(result, 'data.frame')
  expect_equal(ncol(result), 3)
  expect_equal(nrow(result), nrow(spdf))
  expect_equal(result$area_id, spdf$area_id)
  expect_equal(result$response, spdf$response)
  expect_equal(result$N, rep(NA, nrow(result)))
  
  expect_is(result_binom, 'data.frame')
  expect_equal(ncol(result_binom), 3)
  expect_equal(nrow(result_binom), nrow(spdf_binom))
  expect_equal(result_binom$area_id, spdf_binom$area_id)
  expect_equal(result_binom$response, spdf_binom$response)
  expect_equal(result_binom$N, spdf_binom$sample_size)
  
})

test_that("getCovariateData function gives errors when it should", {
  
  expect_error(getCovariateRasters('/home/rasters', '.tif$', spdf))
  
  # Save .tif files in tempdir()
  r <- raster::raster(ncol=20, nrow=20)
  r[] <- sapply(1:raster::ncell(r), function(x) rnorm(1, ifelse(x %% 20 != 0, x %% 20, 20), 3))
  r2 <- raster::raster(ncol=20, nrow=20)
  r2[] <- sapply(1:raster::ncell(r), function(x) rnorm(1, ceiling(x/10), 3))
  cov_stack <- raster::stack(r, r2)
  raster::writeRaster(r, paste0(tempdir(), '/cov1.tif'), overwrite = TRUE)
  raster::writeRaster(r2, paste0(tempdir(), '/cov2.tif'), overwrite = TRUE)
  
  expect_is(getCovariateRasters(tempdir(), '.tif$', spdf), 'RasterBrick')
  
})

test_that("extractCoordsForMesh function behaves as it should", {

  cl <- parallel::makeCluster(2)
  doParallel::registerDoParallel(cl)
  cov_data <- parallelExtract(cov_stack, spdf, fun = NULL, id = 'area_id')
  parallel::stopCluster(cl)
  foreach::registerDoSEQ()
  
  result <- extractCoordsForMesh(cov_stack, cov_data)

  expect_error(extractCoordsForMesh(cov_data, cov_stack))
  expect_is(result, 'matrix')

})
